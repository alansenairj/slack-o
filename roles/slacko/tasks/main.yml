---
# tasks file for slacko



  - name: Clone a repo with separate git directory
    ansible.builtin.git:
      repo: https://github.com/LeonardoDG2084/iaac_slacko-api
      dest: /opt/slacko-api/
      force: yes
    tags:
      - gitclone


  - name: Instalar NTP
    apt:
       name: ntp
       state: present
    notify:
       - ntp
       - crond
       - env
    tags:
       - ntp   
     

  - name: copiar configuração do ntp
    copy:
        src: ntp.conf
        dest: "{{ ntppath }}"
    notify: 
      - horacerta
    tags: 
      - horacerta
     

  - name: Instalaçao do MongoDB
    apt: 
      name: mongodb
      state: present
      update_cache: yes

    tags:
        - mongodb
    notify:
        - restart mongodb


  - name: Instalaço dos requerimentos do Python
    pip:
      requirements: /opt/slacko-api/requeriments.txt
    tags: 
      - python


  - name: Criar o diretório pela variável do path
    file:
        path: "{{ path }}"
        state: directory
        owner: root
        group: root 
        mode: 0755 
    tags: path

  - name: Copiar o script .sh parametrizavel
    template:
        src: slacko/templates/slacko-api.sh
        dest: "{{ path }}"
        owner: root
        group: root
        mode: 0755
    tags: 
      - script



  - name: Copiar arquivo que transforma script em service
    copy:
      src: slacko-api.service
      dest: /etc/systemd/system
      owner: root
      group: root
    notify:
      - copy.service
      - start.service
    tags: 
      - copy.service


  - name: Instalar docker e dependencias
    apt:
        name: python3-pip, docker.io
        state: present

  - name: Iniciar o Docker
    service:
      name: docker
      state: started
    become: true  

  - name: Install docker python module
    pip:
        name: docker


  - name: Criar o container do mongodb xpress
    docker_container:
      name: testing
      image: mongo-express:0.54.0
      state: started
      restart: yes
      env: 
        ME_CONFIG_MONGODB_ADMINUSERNAME=admin
        ME_CONFIG_MONGODB_ADMINPASSWORD=pass
        ME_CONFIG_MONGODB_SERVER=mongodb
        ME_CONFIG_BASICAUTH_USERNAME=admin
        ME_CONFIG_BASICAUTH_PASSWORD=1234



 
    become: true

    tags: 
      - deploy
  



